<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en" th:attr="data-api-base=${apiBase}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="'Dashboard | ' + ${appName}">Dashboard | Todo Insight</title>
    <link rel="icon" type="image/svg+xml" th:href="@{/images/favicon.svg}">
    <link rel="icon" type="image/x-icon" th:href="@{/images/favicon.ico}">
    <link rel="stylesheet" th:href="@{/css/styles.css}">
</head>
<body>
<nav th:replace="~{fragments/navbar :: navbar('dashboard')}"></nav>

<main class="main-content">
    <div class="dashboard-container">

        <!-- Input + Filters + Actions Group -->
        <div class="input-filters-group">
            <div class="quick-add">
                <input type="text" id="quickAddInput" class="quick-add-input" placeholder="What needs to be done?" maxlength="255">
                <button class="btn btn-primary quick-add-btn" id="quickAddBtn">Add</button>
            </div>
            <div class="filters-row">
                <select id="filterStatus" class="filter-select" aria-label="Filter by status"></select>
                <select id="filterPriority" class="filter-select" aria-label="Filter by priority"></select>
                <button class="btn btn-ghost btn-sm" id="clearFiltersBtn">Clear</button>
                <div class="filters-spacer"></div>
                <button class="btn btn-ghost btn-sm" id="statsBtn">Stats</button>
                <button class="btn btn-primary btn-sm" id="aiInsightsBtn">AI Insights</button>
            </div>
        </div>

        <!-- Todo List -->
        <div class="todo-list" id="todoList"></div>

        <!-- Empty State -->
        <div id="emptyState" class="hidden">
            <div class="empty-todo-state">
                <h3>No tasks yet</h3>
                <p>Add your first task above to get started.</p>
            </div>
        </div>

        <!-- Loading State -->
        <div id="loadingState" class="hidden">
            <div class="loading-state">
                <div class="spinner"></div>
            </div>
        </div>

        <!-- Pagination -->
        <div id="paginationContainer"></div>
    </div>
</main>

<!-- Footer -->
<footer class="dashboard-footer">
    <p th:text="'© 2026 ' + ${appName} + '. All rights reserved.'">© 2026 Todo Insight. All rights reserved.</p>
</footer>

<!-- Todo Modals -->
<div th:replace="~{fragments/todo-modal :: modals}"></div>

<!-- Stats Modal -->
<div th:replace="~{fragments/stats-modal :: modal}"></div>

<!-- AI Insights Modal -->
<div th:replace="~{fragments/ai-insights-modal :: modal}"></div>

<div class="toast-container" id="toastContainer"></div>

<!-- Markdown Parser -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

<script th:src="@{/js/api.js}"></script>
<script th:src="@{/js/auth.js}"></script>
<script th:src="@{/js/utils.js}"></script>
<script th:replace="~{fragments/todo-modal :: modal-scripts}"></script>
<script th:replace="~{fragments/stats-modal :: modal-scripts}"></script>
<script th:replace="~{fragments/ai-insights-modal :: modal-scripts}"></script>
<script>
    let currentPage = 0;
    let currentFilters = {};

    document.addEventListener('DOMContentLoaded', async () => {
        if (!Auth.requireAuth()) return;
        Auth.initAuthUI();
        await loadDropdowns();
        setupEventListeners();
        initTodoModals();
        StatsModal.init();
        AiInsights.init();
        await loadData();
    });

    async function loadDropdowns() {
        const [statuses, priorities] = await Promise.all([
            DropdownLoader.loadStatuses(),
            DropdownLoader.loadPriorities()
        ]);
        DropdownLoader.populateSelect(document.getElementById('filterStatus'), statuses, true, 'All Status');
        DropdownLoader.populateSelect(document.getElementById('filterPriority'), priorities, true, 'All Priority');
        DropdownLoader.populateSelect(document.getElementById('status'), statuses);
        DropdownLoader.populateSelect(document.getElementById('priority'), priorities);
    }

    function setupEventListeners() {
        document.getElementById('quickAddBtn').addEventListener('click', quickAddTodo);
        document.getElementById('quickAddInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') quickAddTodo();
        });
        document.getElementById('filterStatus').addEventListener('change', handleFilterChange);
        document.getElementById('filterPriority').addEventListener('change', handleFilterChange);
        document.getElementById('clearFiltersBtn').addEventListener('click', clearFilters);
        document.getElementById('statsBtn').addEventListener('click', () => StatsModal.open());
        document.getElementById('aiInsightsBtn').addEventListener('click', () => AiInsights.open());
    }


    async function loadData() {
        await loadTodos();
    }

    async function loadTodos() {
        const todoList = document.getElementById('todoList');
        const emptyState = document.getElementById('emptyState');
        const loadingState = document.getElementById('loadingState');

        todoList.innerHTML = '';
        emptyState.classList.add('hidden');
        loadingState.classList.remove('hidden');

        try {
            const params = {page: currentPage, size: 20, sort: 'createdAt,desc', ...currentFilters};
            const page = await Api.todos.list(params);
            loadingState.classList.add('hidden');

            if (!page.content || page.content.length === 0) {
                emptyState.classList.remove('hidden');
                document.getElementById('paginationContainer').innerHTML = '';
                return;
            }

            renderTodos(page.content);
            renderPagination(page);
        } catch (error) {
            loadingState.classList.add('hidden');
            Toast.error('Failed to load todos');
        }
    }

    function renderTodos(todos) {
        const sortedTodos = [...todos].sort((a, b) => {
            const aCompleted = a.status === 'COMPLETED' ? 1 : 0;
            const bCompleted = b.status === 'COMPLETED' ? 1 : 0;
            return aCompleted - bCompleted;
        });

        const todoList = document.getElementById('todoList');
        todoList.innerHTML = sortedTodos.map(todo => {
            const isCompleted = todo.status === 'COMPLETED';
            const isCancelled = todo.status === 'CANCELLED';

            return `
                <div class="todo-item ${isCompleted ? 'completed' : ''}" onclick="openTodoModal('${todo.id}')">
                    <div class="todo-check ${isCompleted ? 'checked' : ''} ${isCancelled ? 'disabled' : ''}"
                         onclick="event.stopPropagation(); toggleTodoStatus('${todo.id}', ${!isCompleted})">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                            <polyline points="20 6 9 17 4 12"></polyline>
                        </svg>
                    </div>
                    <div class="todo-content">
                        <div class="todo-title ${isCompleted ? 'done' : ''}">${Utils.escapeHtml(todo.title)}</div>
                        ${todo.description ? `<div class="todo-description">${Utils.escapeHtml(todo.description.substring(0, 60))}${todo.description.length > 60 ? '...' : ''}</div>` : ''}
                    </div>
                    <div class="todo-meta">
                        <span class="badge badge-priority-${todo.priority.toLowerCase()}">${Utils.formatEnumLabel(todo.priority)}</span>
                        ${todo.dueDate ? `<span class="todo-due">${Utils.formatDate(todo.dueDate)}</span>` : ''}
                    </div>
                </div>
            `;
        }).join('');
    }

    function renderPagination(page) {
        const container = document.getElementById('paginationContainer');
        if (page.totalPages <= 1) {
            container.innerHTML = '';
            return;
        }

        let buttons = '';

        // Previous button
        buttons += `<button class="page-btn" data-page="${page.number - 1}" ${page.first ? 'disabled' : ''}>←</button>`;

        // Page numbers
        for (let i = 0; i < page.totalPages; i++) {
            if (i === 0 || i === page.totalPages - 1 || Math.abs(i - page.number) <= 1) {
                buttons += `<button class="page-btn ${i === page.number ? 'active' : ''}" data-page="${i}">${i + 1}</button>`;
            } else if (Math.abs(i - page.number) === 2) {
                buttons += `<span style="padding: 0 var(--space-2);">...</span>`;
            }
        }

        // Next button
        buttons += `<button class="page-btn" data-page="${page.number + 1}" ${page.last ? 'disabled' : ''}>→</button>`;

        container.innerHTML = `<div class="pagination-row">${buttons}</div>`;

        container.querySelectorAll('.page-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const pageNum = parseInt(btn.dataset.page);
                if (!isNaN(pageNum) && pageNum >= 0 && pageNum < page.totalPages) {
                    currentPage = pageNum;
                    loadTodos();
                }
            });
        });
    }

    async function quickAddTodo() {
        const input = document.getElementById('quickAddInput');
        const title = input.value.trim();
        if (!title) return;

        const btn = document.getElementById('quickAddBtn');
        Utils.setButtonLoading(btn, true);

        try {
            await Api.todos.create({title, status: 'NOT_STARTED', priority: 'MEDIUM'});
            input.value = '';
            await loadData();
            Toast.success('Task added');
        } catch (error) {
            Toast.error(error.message || 'Failed to add task');
        } finally {
            Utils.setButtonLoading(btn, false);
        }
    }

    async function toggleTodoStatus(id, setCompleted) {
        try {
            await Api.todos.updateStatus(id, setCompleted ? 'COMPLETED' : 'NOT_STARTED');
            await loadData();
        } catch (error) {
            Toast.error('Failed to update');
            await loadTodos();
        }
    }

    function handleFilterChange() {
        currentPage = 0;
        currentFilters = {
            status: document.getElementById('filterStatus').value || undefined,
            priority: document.getElementById('filterPriority').value || undefined
        };
        loadTodos();
    }

    function clearFilters() {
        document.getElementById('filterStatus').value = '';
        document.getElementById('filterPriority').value = '';
        currentFilters = {};
        currentPage = 0;
        loadTodos();
    }
</script>
</body>
</html>

